name: Sync Web Chat Releases

on:
  workflow_dispatch:

jobs:
  sync-releases:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Fetch and extract releases
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Create gh-pages directory
          mkdir -p gh-pages/botframework-webchat
          
          # Fetch all releases from microsoft/botframework-webchat using gh CLI
          echo "Fetching releases from microsoft/botframework-webchat..."
          
          # Get list of all releases (tag names)
          gh release list --repo microsoft/botframework-webchat --limit 1000 | while read -r line; do
            # Extract tag name (first column)
            tag_name=$(echo "$line" | awk '{print $1}')
            
            # Remove 'v' prefix if present (e.g., v4.18.0 -> 4.18.0)
            version="${tag_name#v}"
            
            echo "Processing release: $tag_name (version: $version)"
            
            # Create version directory
            version_dir="gh-pages/botframework-webchat/$version"
            mkdir -p "$version_dir"
            
            # Create unique temp directory for this release
            temp_dir=$(mktemp -d -t "release-${version}-XXXXXX")
            
            # Download all tarballs (.tgz files) for this release
            echo "  Downloading all tarballs..."
            if gh release download "$tag_name" --repo microsoft/botframework-webchat --pattern "*.tgz" --dir "$temp_dir" 2>&1; then
              # Count downloaded files
              tarball_count=$(find "$temp_dir" -name "*.tgz" | wc -l)
              
              if [ "$tarball_count" -gt 0 ]; then
                echo "  ✓ Downloaded $tarball_count tarball(s)"
                
                # Extract each tarball to the version directory
                for tarball in "$temp_dir"/*.tgz; do
                  if [ -f "$tarball" ]; then
                    tarball_basename=$(basename "$tarball" .tgz)
                    echo "    Extracting $tarball_basename.tgz..."
                    
                    # Create subdirectory for this tarball to avoid conflicts
                    tarball_extract_dir="$version_dir/$tarball_basename"
                    mkdir -p "$tarball_extract_dir"
                    
                    tar -xzf "$tarball" -C "$tarball_extract_dir" --strip-components=1 2>&1 || echo "    ⚠ Failed to extract $tarball_basename.tgz"
                  fi
                done
                
                echo "  ✓ Completed $version"
              else
                echo "  ⚠ No tarballs found for $tag_name"
                # Clean up the empty directory
                rmdir "$version_dir" 2>/dev/null || true
              fi
            else
              echo "  ⚠ Failed to download tarballs for $tag_name"
              # Clean up the empty directory
              rmdir "$version_dir" 2>/dev/null || true
            fi
            
            # Clean up temp directory
            rm -rf "$temp_dir"
          done
          
          echo "All releases processed."
      
      - name: Create zip archive
        run: |
          echo "Creating zip archive of gh-pages directory..."
          cd gh-pages
          zip -r ../gh-pages.zip .
          cd ..
          echo "Archive created: gh-pages.zip"
          ls -lh gh-pages.zip
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: gh-pages
          path: gh-pages.zip
          retention-days: 90
      
      - name: Create pull request to gh-pages branch
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Create a unique branch name for this update
          BRANCH_NAME="update-gh-pages-$(date +%Y%m%d-%H%M%S)"
          
          # Check if gh-pages branch exists remotely
          if git ls-remote --exit-code --heads origin gh-pages >/dev/null 2>&1; then
            echo "gh-pages branch exists, checking it out..."
            git fetch origin gh-pages
            git checkout -b "$BRANCH_NAME" origin/gh-pages
          else
            echo "gh-pages branch does not exist, creating orphan branch..."
            git checkout --orphan "$BRANCH_NAME"
            git rm -rf . || true
          fi
          
          # Copy contents from gh-pages directory to root
          echo "Copying contents from gh-pages directory..."
          cp -r gh-pages/. .
          
          # Add and commit changes
          git add .
          
          if git diff --staged --quiet; then
            echo "No changes to commit"
            exit 0
          fi
          
          git commit -m "Update Web Chat CDN files from microsoft/botframework-webchat releases"
          
          # Push the branch
          git push origin "$BRANCH_NAME"
          
          # Create pull request
          gh pr create \
            --base gh-pages \
            --head "$BRANCH_NAME" \
            --title "Update Web Chat CDN files" \
            --body "This PR updates the Web Chat CDN files from the latest releases of microsoft/botframework-webchat.

          Workflow run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

          The files have been extracted and organized by version under botframework-webchat/{version}/."
