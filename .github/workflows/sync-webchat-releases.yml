name: Sync Web Chat Releases

on:
  workflow_dispatch:

jobs:
  sync-releases:
    runs-on: ubuntu-latest

    permissions:
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Fetch and extract releases
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail

          # Create gh-pages directory
          mkdir -p gh-pages/botframework-webchat

          echo "Fetching releases from microsoft/botframework-webchat..."

          # Use JSON output to robustly get all tag names
          gh release list --repo microsoft/botframework-webchat --limit 1000 --json tagName --jq '.[].tagName' | while read -r tag_name; do
            if [ -z "$tag_name" ]; then
              continue
            fi

            # Remove 'v' prefix if present (e.g., v4.18.0 -> 4.18.0)
            version="${tag_name#v}"

            echo "Processing release: $tag_name (version: $version)"

            version_dir="gh-pages/botframework-webchat/$version"
            mkdir -p "$version_dir"

            asset="botframework-webchat-${version}.tgz"
            echo "  Downloading $asset..."

            # One temp dir per release to hold the tarball
            temp_dir=$(mktemp -d)

            if gh release download "$tag_name" \
              --repo microsoft/botframework-webchat \
              --pattern "$asset" \
              --dir "$temp_dir" 2>&1; then

              tarball="$temp_dir/$asset"

              if [ -f "$tarball" ]; then
                echo "  ✓ Downloaded $asset"

                # Extract only package/dist/ contents and strip the dist/ prefix
                echo "    Extracting package/dist/ from $asset into $version_dir (stripping package/dist/)..."
                if tar -xzf "$tarball" -C "$version_dir" --strip-components=2 'package/dist/*' 2>&1; then
                  rm "$version_dir/stats.json"
                  echo "  ✓ Completed $version"
                else
                  echo "  ⚠ Failed to extract dist/ from $asset for $tag_name"
                  rm -rf "$version_dir"
                fi
              else
                echo "  ⚠ Asset $asset not found for $tag_name"
                rm -rf "$version_dir"
              fi
            else
              echo "  ⚠ Failed to download $asset for $tag_name"
              rm -rf "$version_dir"
            fi

            # Clean up temp directory
            rm -rf "$temp_dir"
          done

          echo "All releases processed."

      - name: Create zip archive
        run: |
          echo "Creating zip archive of gh-pages directory..."
          cd gh-pages
          zip -r ../gh-pages.zip .
          cd ..
          echo "Archive created: gh-pages.zip"
          ls -lh gh-pages.zip

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: gh-pages
          path: gh-pages.zip
          retention-days: 90

  create-pr:
    runs-on: ubuntu-latest
    needs: sync-releases

    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: gh-pages
          path: ${{ runner.temp }}/artifacts

      - name: Create pull request to gh-pages
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail

          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Variables
          BRANCH_NAME="update-gh-pages-$(date +%Y%m%d-%H%M%S)"
          ARTIFACT_ZIP="${{ runner.temp }}/artifacts/gh-pages.zip"
          CONTENT_DIR="${{ runner.temp }}/gh-pages-content"

          echo "Checking out new branch from origin/gh-pages..."
          git fetch origin gh-pages
          git checkout -b "$BRANCH_NAME" origin/gh-pages

          echo "Unzipping artifact and overlaying contents..."
          mkdir -p "$CONTENT_DIR"
          unzip -q "$ARTIFACT_ZIP" -d "$CONTENT_DIR"
          cp -r "$CONTENT_DIR/." .

          # Add and commit changes (no deletions assumed)
          git add .
          if git diff --staged --quiet; then
            echo "No changes to commit"
            exit 0
          fi

          git commit -m "Update Web Chat CDN files from microsoft/botframework-webchat releases"

          # Push the branch
          git push origin "$BRANCH_NAME"

          # Create pull request
          gh pr create \
            --base gh-pages \
            --head "$BRANCH_NAME" \
            --title "Update Web Chat CDN files" \
            --body "This PR updates the Web Chat CDN files from the latest releases of microsoft/botframework-webchat.

          Workflow run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

          The files have been extracted and organized by version under botframework-webchat/{version}/, keeping only dist/ contents."
